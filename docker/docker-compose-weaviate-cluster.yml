version: '3.5'

services:
  weaviate-node1:
    container_name: weaviate-node1
    image: semitechnologies/weaviate:1.27.0
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "50051:50051"
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      DEFAULT_VECTORIZER_MODULE: 'none'
      CLUSTER_HOSTNAME: 'node1'
      CLUSTER_GOSSIP_BIND_PORT: '7946'
      CLUSTER_DATA_BIND_PORT: '7947'
      CLUSTER_JOIN: 'weaviate-node1:7946,weaviate-node2:7946,weaviate-node3:7946'
      RAFT_JOIN: 'node1,node2,node3'
      RAFT_BOOTSTRAP_EXPECT: 3
      ENABLE_MODULES: ''
      DISK_USE_WARNING_PERCENTAGE: 90
      DISK_USE_READONLY_PERCENTAGE: 95
    volumes:
      - weaviate_node1_data:/var/lib/weaviate
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/v1/.well-known/ready"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 4G

  weaviate-node2:
    container_name: weaviate-node2
    image: semitechnologies/weaviate:1.27.0
    restart: unless-stopped
    ports:
      - "8081:8080"
      - "50052:50051"
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      DEFAULT_VECTORIZER_MODULE: 'none'
      CLUSTER_HOSTNAME: 'node2'
      CLUSTER_GOSSIP_BIND_PORT: '7946'
      CLUSTER_DATA_BIND_PORT: '7947'
      CLUSTER_JOIN: 'weaviate-node1:7946,weaviate-node2:7946,weaviate-node3:7946'
      RAFT_JOIN: 'node1,node2,node3'
      RAFT_BOOTSTRAP_EXPECT: 3
      ENABLE_MODULES: ''
      DISK_USE_WARNING_PERCENTAGE: 90
      DISK_USE_READONLY_PERCENTAGE: 95
    volumes:
      - weaviate_node2_data:/var/lib/weaviate
    depends_on:
      weaviate-node1:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 4G

  weaviate-node3:
    container_name: weaviate-node3
    image: semitechnologies/weaviate:1.27.0
    restart: unless-stopped
    ports:
      - "8082:8080"
      - "50053:50051"
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      DEFAULT_VECTORIZER_MODULE: 'none'
      CLUSTER_HOSTNAME: 'node3'
      CLUSTER_GOSSIP_BIND_PORT: '7946'
      CLUSTER_DATA_BIND_PORT: '7947'
      CLUSTER_JOIN: 'weaviate-node1:7946,weaviate-node2:7946,weaviate-node3:7946'
      RAFT_JOIN: 'node1,node2,node3'
      RAFT_BOOTSTRAP_EXPECT: 3
      ENABLE_MODULES: ''
      DISK_USE_WARNING_PERCENTAGE: 90
      DISK_USE_READONLY_PERCENTAGE: 95
    volumes:
      - weaviate_node3_data:/var/lib/weaviate
    depends_on:
      weaviate-node1:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 4G

volumes:
  weaviate_node1_data:
  weaviate_node2_data:
  weaviate_node3_data:

networks:
  default:
    name: vector-db-benchmark
